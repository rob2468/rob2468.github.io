<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MS2BSFXL7Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MS2BSFXL7Q');
</script>
<!-- End Google Analytics -->

  
  <title>为 GCDWebServer 引入 WebSocket 支持 | 陈军的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="前言  借助一些工具库，iOS 设备可以配置成为服务器，在此之上可以做许多有意思的事情。例如，HttpServerDebug 基于这种能力，提供了现场调试 iOS App 的能力。">
<meta property="og:type" content="article">
<meta property="og:title" content="为 GCDWebServer 引入 WebSocket 支持">
<meta property="og:url" content="https://rob2468.github.io/2019/06/15/hsd-websocket/index.html">
<meta property="og:site_name" content="陈军的博客">
<meta property="og:description" content="前言  借助一些工具库，iOS 设备可以配置成为服务器，在此之上可以做许多有意思的事情。例如，HttpServerDebug 基于这种能力，提供了现场调试 iOS App 的能力。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://media.githubusercontent.com/media/rob2468/rob2468.github.io/master/images/2019-06-15-websocket-retain.png">
<meta property="article:published_time" content="2019-06-15T00:00:00.000Z">
<meta property="article:modified_time" content="2023-08-12T16:06:03.907Z">
<meta property="article:author" content="陈军">
<meta property="article:tag" content="HttpServerDebug">
<meta property="article:tag" content="WebSocket">
<meta property="article:tag" content="网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://media.githubusercontent.com/media/rob2468/rob2468.github.io/master/images/2019-06-15-websocket-retain.png">
  
    <link rel="alternate" href="/atom.xml" title="陈军的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header" class="">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    

    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <!-- 小屏设备的展开菜单入口 -->
        <a id="main-nav-toggle" class="nav-icon"></a>
        <!-- 导航菜单 -->
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      
        <a id="logo-wrap" href="/">
          <img
            id="logo-img"
            src="https://gw.alipayobjects.com/mdn/rms_6dcfb1/afts/img/A*6l2PRIgAfEAAAAAAAAAAAAAAARQnAQ"
            alt=""
          />
        </a>
      
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <!-- 搜索框 -->
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://rob2468.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
          <article
  id="post-hsd-websocket"
  class="h-entry article article-type-post"
  itemprop="blogPost"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div class="article-meta">
    <a
  href="/2019/06/15/hsd-websocket/"
  class="article-date"
>
  <time
    class="dt-published"
    datetime="2019-06-15T00:00:00.000Z"
    itemprop="datePublished"
  >
    2019-06-15
  </time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a
        class="p-name article-title"
        href="/2019/06/15/hsd-websocket/"
      >
        为 GCDWebServer 引入 WebSocket 支持
      </a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 class="title"></h1>

<h2 id="section_1">前言</h2>

<p>借助一些工具库，iOS 设备可以配置成为服务器，在此之上可以做许多有意思的事情。例如，<a href="https://github.com/rob2468/HttpServerDebug" target="_blank">HttpServerDebug</a> 基于这种能力，提供了现场调试 iOS App 的能力。</p>
<span id="more"></span>

<p><a href="https://github.com/robbiehanson/CocoaHTTPServer" target="_blank">CocoaHTTPServer</a> 是比较早期的提供服务器能力的库，(基础 Socket 通信能力由 <a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank">CocoaAsyncSocket</a> 提供，)现在已不再维护。</p>
<p><a href="https://github.com/swisspol/GCDWebServer" target="_blank">GCDWebServer</a> 也是一个提供服务器能力的工具，基于 GCD 实现，当前仍在维护中。</p>
<p>HSD（HttpServerDebug） 基于 GCDWebServer。HSD 希望能够主动的把信息发送到前端，这依赖于 WebSocket 协议，但是 GCDWebServer 不支持。</p>
<p>HSD 对 GCDWebServer 进行二次开发，增加 WebSocket 能力，并且不再同步原始 GCDWebServer 库。这是支持 WebSocket 协议的一次实践，并没有完备的支持 WebSocket 的所有方面，如新版本的 WebSochet 协议、加密数据传输等。</p>
<h2 id="section_2">Socket 实现</h2>

<p>Http 和 WebSocket 都是应用层的协议，其底层都依赖 Socket 进行通信。</p>
<p>GCDWebServer 中，Socket 的建立使用 POSIX C 函数实现。生成的核心数据对象是一对 Socket 文件描述符，分别代表服务端和客户端。对 Socket 文件描述符的监听、读取、写入均使用 GCD 函数进行了封装。</p>
<h2 id="section_3">WebSocket 协议</h2>

<p>WebSocket 协议是借用 HTTP 101 switch protocol 来完成协议转换，从 HTTP 协议切换成 WebSocket 通信协议。一个典型的建立连接请求和响应头如下，具体含义见参考文献链接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Request Headers</span><br><span class="line">GET ws://localhost:5555/ HTTP/1.1</span><br><span class="line">Host: localhost:5555</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Origin: http://localhost:5555</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Cookie: locale=zh-cn</span><br><span class="line">Sec-WebSocket-Key: qtAGynUVRNU3JdTH1dsQiA==</span><br><span class="line">Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits</span><br><span class="line"></span><br><span class="line">Response Headers</span><br><span class="line">HTTP/1.1 101 Web Socket Protocol Handshake</span><br><span class="line">WebSocket-Location: ws://localhost:5555/</span><br><span class="line">Sec-WebSocket-Accept: We1qmJgFvf8w3cDqTuUO5B6lrNA=</span><br><span class="line">Upgrade: WebSocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">WebSocket-Origin: http://localhost:5555</span><br></pre></td></tr></table></figure>

<p>WebSocket 协议传输的数据以 Frame 为单位，每个 Frame 都有严格的数据结构，如下表所示。其中每个位以字节流形式考察，具体含义见参考文献链接。</p>
<pre><code>  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+
</code></pre>

<h2 id="section_4">持有关系</h2>

<p><img src="https://media.githubusercontent.com/media/rob2468/rob2468.github.io/master/images/2019-06-15-websocket-retain.png"></p>
<p>如上图所示，增加 WebSocket 协议支持后，对象实例的持有关系有一些变化。GCDWebServer 表示服务器实例，GCDWebServerConnection 表示一次通信连接实例。</p>
<p>GCDWebServer 实例和 GCDWebServerConnection 实例的对应关系是 1 : n，这在修改前后都是一样的。修改前，GCDWebServerConnection 实例没有显式的声明被某个对象持有，其内部实现中，dispatch_read 和 dispatch_write 的 block 持有其自身，并在 block 执行结束后释放。</p>
<p>修改后，明确了 GCDWebServerConnection 实例的持有关系。GCDWebServer 实例接收到请求并实例出 GCDWebServerConnection 对象后，显示持有该对象。</p>
<p>HSDGWebSocket 是新增的负责处理 WebSocket 协议的类。GCDWebServerConnection 检测到当前请求为 WebSocket 请求时，实例出 HSDGWebSocket 对象，并显示持有。他们的对应关系是 1 : 1。</p>
<h2 id="section_5">建立连接</h2>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)isWebSocketRequest:(<span class="built_in">NSDictionary</span> *)requestHeaders &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *connectionHeaderValue = [requestHeaders objectForKey:<span class="string">@&quot;Connection&quot;</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *upgradeHeaderValue = [requestHeaders objectForKey:<span class="string">@&quot;Upgrade&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BOOL</span> isWebSocket = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (!upgradeHeaderValue || !connectionHeaderValue) &#123;</span><br><span class="line">        isWebSocket = <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([upgradeHeaderValue caseInsensitiveCompare:<span class="string">@&quot;WebSocket&quot;</span>] != <span class="built_in">NSOrderedSame</span>) &#123;</span><br><span class="line">        isWebSocket = <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([connectionHeaderValue rangeOfString:<span class="string">@&quot;Upgrade&quot;</span> options:<span class="built_in">NSCaseInsensitiveSearch</span>].location == <span class="built_in">NSNotFound</span>) &#123;</span><br><span class="line">        isWebSocket = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isWebSocket;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上代码所示，接收到请求后，根据请求头判断是否是 WebSocket 请求。如果是 WekSocket 请求，则发送对应的响应头，如下代码所示。请求和响应的格式和值见 WebSocket 协议的定义。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sendResponseHeaders &#123;</span><br><span class="line">    <span class="comment">// request info</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *requestHeaders = <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFHTTPMessageCopyAllHeaderFields</span>(<span class="keyword">self</span>.requestMessage));</span><br><span class="line">    <span class="built_in">NSString</span> *origin = [requestHeaders objectForKey:<span class="string">@&quot;Origin&quot;</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *host = [requestHeaders objectForKey:<span class="string">@&quot;Host&quot;</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *secWebSocketKey = [requestHeaders objectForKey:<span class="string">@&quot;Sec-WebSocket-Key&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURL</span> *requestURL = <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFHTTPMessageCopyRequestURL</span>(<span class="keyword">self</span>.requestMessage));</span><br><span class="line">    <span class="built_in">NSString</span> *relativeString = [requestURL relativeString];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// response</span></span><br><span class="line">    <span class="built_in">CFHTTPMessageRef</span> responseMessage = <span class="built_in">CFHTTPMessageCreateResponse</span>(kCFAllocatorDefault, <span class="number">101</span>, <span class="built_in">CFSTR</span>(<span class="string">&quot;Web Socket Protocol Handshake&quot;</span>), kCFHTTPVersion1_1);</span><br><span class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(responseMessage, <span class="built_in">CFSTR</span>(<span class="string">&quot;Connection&quot;</span>), <span class="built_in">CFSTR</span>(<span class="string">&quot;Upgrade&quot;</span>));</span><br><span class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(responseMessage, <span class="built_in">CFSTR</span>(<span class="string">&quot;Upgrade&quot;</span>), <span class="built_in">CFSTR</span>(<span class="string">&quot;WebSocket&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(responseMessage, <span class="built_in">CFSTR</span>(<span class="string">&quot;WebSocket-Origin&quot;</span>), (__bridge <span class="built_in">CFStringRef</span>)origin);</span><br><span class="line">    <span class="built_in">NSString</span> *locationValue = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;ws://%@%@&quot;</span>, host, relativeString];</span><br><span class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(responseMessage, <span class="built_in">CFSTR</span>(<span class="string">&quot;WebSocket-Location&quot;</span>), (__bridge <span class="built_in">CFStringRef</span>)locationValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sec-WebSocket-Accept</span></span><br><span class="line">    <span class="built_in">NSString</span> *guid = <span class="string">@&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *acceptValue = [[secWebSocketKey stringByAppendingString:guid] dataUsingEncoding: <span class="built_in">NSUTF8StringEncoding</span>].sha1Digest.base64Encoded;</span><br><span class="line">    <span class="keyword">if</span> (acceptValue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(responseMessage, <span class="built_in">CFSTR</span>(<span class="string">&quot;Sec-WebSocket-Accept&quot;</span>), (__bridge <span class="built_in">CFStringRef</span>)acceptValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFDataRef</span> data = <span class="built_in">CFHTTPMessageCopySerializedMessage</span>(responseMessage);</span><br><span class="line">    [<span class="keyword">self</span> writeData:(__bridge <span class="built_in">NSData</span>*)data withCompletionBlock:^(<span class="built_in">BOOL</span> sucess) &#123;&#125;];</span><br><span class="line">    <span class="built_in">CFRelease</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="section_6">发送和接收信息</h2>

<p>下面两段代码分别是，从服务端发送信息到前端和服务端接收前端发来的信息。其中关于字节流的处理见 WebSocket 协议 Frame 的定义。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sendMessage:(<span class="built_in">NSString</span> *)msg &#123;</span><br><span class="line">    <span class="built_in">NSData</span> *msgData = [msg dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="built_in">NSMutableData</span> *data = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSUInteger</span> length = msgData.length;</span><br><span class="line">    <span class="keyword">if</span> (length &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        data = [<span class="built_in">NSMutableData</span> dataWithCapacity:(length + <span class="number">2</span>)];</span><br><span class="line">        [data appendBytes:<span class="string">&quot;\x81&quot;</span> length:<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">UInt8</span> len = (<span class="built_in">UInt8</span>)length;</span><br><span class="line">        [data appendBytes:&amp;len length:<span class="number">1</span>];</span><br><span class="line">        [data appendData:msgData];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (length &lt;= <span class="number">0xFFFF</span>) &#123;</span><br><span class="line">        data = [<span class="built_in">NSMutableData</span> dataWithCapacity:(length + <span class="number">4</span>)];</span><br><span class="line">        [data appendBytes:<span class="string">&quot;\x81\x7E&quot;</span> length:<span class="number">2</span>];</span><br><span class="line">        <span class="built_in">UInt16</span> len = (<span class="built_in">UInt16</span>)length;</span><br><span class="line">        [data appendBytes:(<span class="built_in">UInt8</span>[])&#123;len &gt;&gt; <span class="number">8</span>, len &amp; <span class="number">0xFF</span>&#125; length:<span class="number">2</span>];</span><br><span class="line">        [data appendData:msgData];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        data = [<span class="built_in">NSMutableData</span> dataWithCapacity:(length + <span class="number">10</span>)];</span><br><span class="line">        [data appendBytes:<span class="string">&quot;\x81\x7F&quot;</span> length:<span class="number">2</span>];</span><br><span class="line">        [data appendBytes:(<span class="built_in">UInt8</span>[])&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, (<span class="built_in">UInt8</span>)(length &gt;&gt; <span class="number">24</span>), (<span class="built_in">UInt8</span>)(length &gt;&gt; <span class="number">16</span>), (<span class="built_in">UInt8</span>)(length &gt;&gt; <span class="number">8</span>), length &amp; <span class="number">0xFF</span>&#125; length:<span class="number">8</span>];</span><br><span class="line">        [data appendData:msgData];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> writeData:data withCompletionBlock:^(<span class="built_in">BOOL</span> success) &#123;&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)handleReceivedData:(<span class="built_in">NSData</span> *)data &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> curPointPos = <span class="number">0</span>;     <span class="comment">// pointer postion cursor</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> msgLength;           <span class="comment">// payload length</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> opCode;</span><br><span class="line">    <span class="built_in">BOOL</span> frameMasked;</span><br><span class="line">    <span class="built_in">NSData</span> *maskingKey;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSData</span> *tmp = [[<span class="built_in">NSData</span> alloc] initWithBytes:(<span class="built_in">UInt8</span> *)[data bytes] length:<span class="number">1</span>];<span class="comment">// first byte</span></span><br><span class="line">    curPointPos++;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UInt8</span> frame = *(<span class="built_in">UInt8</span> *)[tmp bytes];</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isValidWebSocketFrame:frame]) &#123;</span><br><span class="line">        opCode = frame &amp; <span class="number">0x0F</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> closeWebSocket];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tmp = [[<span class="built_in">NSData</span> alloc] initWithBytes:((<span class="built_in">UInt8</span> *)[data bytes] + curPointPos) length:<span class="number">1</span>];</span><br><span class="line">    curPointPos++;</span><br><span class="line"></span><br><span class="line">    frame = *(<span class="built_in">UInt8</span> *)[tmp bytes];</span><br><span class="line">    frameMasked = WS_PAYLOAD_IS_MASKED(frame);</span><br><span class="line">    <span class="built_in">NSUInteger</span> length = WS_PAYLOAD_LENGTH(frame);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (length &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (frameMasked) &#123;</span><br><span class="line">            maskingKey = [[<span class="built_in">NSData</span> alloc] initWithBytes:((<span class="built_in">UInt8</span> *)[data bytes] + curPointPos) length:<span class="number">4</span>];</span><br><span class="line">            curPointPos += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        msgLength = length;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (length == <span class="number">126</span>) &#123;</span><br><span class="line">        tmp = [[<span class="built_in">NSData</span> alloc] initWithBytes:((<span class="built_in">UInt8</span> *)[data bytes] + curPointPos) length:<span class="number">2</span>];</span><br><span class="line">        curPointPos += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UInt8</span> *pFrame = (<span class="built_in">UInt8</span> *)[tmp bytes];</span><br><span class="line">        <span class="built_in">NSUInteger</span> length = ((<span class="built_in">NSUInteger</span>)pFrame[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) | (<span class="built_in">NSUInteger</span>)pFrame[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (frameMasked) &#123;</span><br><span class="line">            maskingKey = [[<span class="built_in">NSData</span> alloc] initWithBytes:((<span class="built_in">UInt8</span> *)[data bytes] + curPointPos) length:<span class="number">4</span>];</span><br><span class="line">            curPointPos += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        msgLength = length;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tmp = [[<span class="built_in">NSData</span> alloc] initWithBytes:((<span class="built_in">UInt8</span> *)[data bytes] + curPointPos) length:<span class="number">8</span>];</span><br><span class="line">        curPointPos += <span class="number">8</span>;</span><br><span class="line">        <span class="comment">// <span class="doctag">FIXME:</span> 64bit data size in memory?</span></span><br><span class="line">        [<span class="keyword">self</span> closeWebSocket];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSData</span> *remainingData = [[<span class="built_in">NSData</span> alloc] initWithBytes:((<span class="built_in">UInt8</span> *)[data bytes] + curPointPos) length:msgLength];</span><br><span class="line">    <span class="keyword">if</span> (frameMasked &amp;&amp; maskingKey) &#123;</span><br><span class="line">        <span class="built_in">NSMutableData</span> *masked = [remainingData mutableCopy];</span><br><span class="line">        <span class="built_in">UInt8</span> *pData = (<span class="built_in">UInt8</span> *)masked.mutableBytes;</span><br><span class="line">        <span class="built_in">UInt8</span> *pMask = (<span class="built_in">UInt8</span> *)maskingKey.bytes;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; msgLength; i++) &#123;</span><br><span class="line">            pData[i] = pData[i] ^ pMask[i % <span class="number">4</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        remainingData = masked;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opCode == WS_OP_TEXT_FRAME) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *msg = [[<span class="built_in">NSString</span> alloc] initWithBytes:[remainingData bytes] length:msgLength encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">        [<span class="keyword">self</span> didReceiveMessage:msg];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.isReadSourceSuspended) &#123;</span><br><span class="line">            <span class="comment">// current reading finished, prepare for the next read event</span></span><br><span class="line">            dispatch_resume(<span class="keyword">self</span>.readSource);</span><br><span class="line">            <span class="keyword">self</span>.socketFDBytesAvailable = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> closeWebSocket];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="section_7">遇到的问题</h2>

<h3>HSDGWebSocket 实例无法释放问题</h3>

<p>HSDGWebSocket 使用 dispatch_source 监听客户端 Socket 文件描述符。如果有数据可以读取，则 event_handler 会读取并解析数据。</p>
<p>最初的实现中设置了 dispatch_source_set_cancel_handler，如果接收到 WebSocket 关闭的信息，调用 dispatch_source_cancel，cancel_handler 会负责执行清理的工作，比如关闭 Socket 文件描述符。但是，测试下来发现，调用 dispatch_source_cancel 并没有触发 cancel_handler 的执行，并且，event_handler 的 block 实例不会释放，而且一直持有着 HSDGWebSocket 实例。</p>
<p>使用另外一种方法解决了这个问题。不再设置 dispatch_source_set_cancel_handler，如果接收到 WebSocket 关闭的信息，主动去执行清理的工作。并且 dispatch_source_set_event_handler 的 block 弱引用 HSDGWebSocket，解决 HSDGWebSocket 无法释放的问题。</p>
<p>dispatch_source_cancel 没有触发 cancel_handler 的原因还不知道。当前的做法可能仍然存在 dispatch_source_set_event_handler 的 block 实例一直未释放的问题。</p>
<h3>参考文献：</h3>

<p><a href="https://github.com/abbshr/abbshr.github.io/issues/22" target="_blank">学习WebSocket协议—从顶层到底层的实现原理（修订版）</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob2468.github.io/2019/06/15/hsd-websocket/" data-id="cll87lpat001wfdokg1syf91k" data-title="为 GCDWebServer 引入 WebSocket 支持" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HttpServerDebug/" rel="tag">HttpServerDebug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/07/06/hsb-practitioners-primer/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          HSB 颜色系统实践入门（译）
        
      </div>
    </a>
  
  
    <a href="/2019/06/10/js-date-and-zone/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">JavaScript Date 和时区</div>
    </a>
  
</nav>

  
</article>





  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script type="text/javascript">

  var gitalk = new Gitalk({
    clientID: 'ca620c98d68fb29d158a',
    clientSecret: 'c8a79801f98bc2971d3b936f5892afd255db7df2',
    repo: 'rob2468.github.io',
    owner: 'rob2468',
    admin: 'rob2468'.split(','),
    id: location.pathname.slice(1, 11),
    labels: 'Gitalk'.split(','),
    perPage: 15,
    pagerDirection: 'last',
    createIssueManually: true,
    distractionFreeMode: false
  });
  gitalk.render('gitalk-container');

  function renderCommentHint(count) {
    setTimeout(() => {
      var issueLinkRef = document.querySelector('.gt-link.gt-link-counts');
      var commmentRef = document.querySelector('.gt-header-comment');
      if (count > 10) {
        return;
      }
      if (!issueLinkRef || !commmentRef) {
        renderCommentHint(count + 1);
        return;
      }

      var hintRef = document.createElement('div');
      hintRef.setAttribute('style', 'color:#999;text-align:right;font-size:0.875em;display:flex;justify-content:flex-end;margin-top:0.5em;');
      hintRef.innerHTML = `<span>* 评论使用 Github Issues 存储，需要你登录 GitHub 账号并授权来发表评论，你也可以直接到 <a href="${issueLinkRef.href}" target="_blank">这里</a> 评论</span>`;
      commmentRef.appendChild(hintRef);
    }, 800);
  }
  renderCommentHint(0);

</script>


        </section>
        
          <aside
  id="sidebar"
  
>
  
    <!-- 目录 table of content -->

  
  
    <div class="widget-wrap">
      <h3 class="widget-title">Contents</h3>
      <div class="widget">
        <p><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#section_1"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#section_2"><span class="toc-text">Socket 实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#section_3"><span class="toc-text">WebSocket 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#section_4"><span class="toc-text">持有关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#section_5"><span class="toc-text">建立连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#section_6"><span class="toc-text">发送和接收信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#section_7"><span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">HSDGWebSocket 实例无法释放问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">参考文献：</span></a></li></ol></li></ol></p>
      </div>
    </div>
  




  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AST/" style="font-size: 10px;">AST</a> <a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a> <a href="/tags/Git/" style="font-size: 11.43px;">Git</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/HttpServerDebug/" style="font-size: 12.86px;">HttpServerDebug</a> <a href="/tags/JavaScript/" style="font-size: 12.86px;">JavaScript</a> <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/Objective-C/" style="font-size: 10px;">Objective-C</a> <a href="/tags/React/" style="font-size: 12.86px;">React</a> <a href="/tags/UML/" style="font-size: 10px;">UML</a> <a href="/tags/Web/" style="font-size: 11.43px;">Web</a> <a href="/tags/WebSocket/" style="font-size: 10px;">WebSocket</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/webpack/" style="font-size: 11.43px;">webpack</a> <a href="/tags/xcodeproj/" style="font-size: 10px;">xcodeproj</a> <a href="/tags/%E5%8A%A8%E6%80%81%E5%8C%96/" style="font-size: 10px;">动态化</a> <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/" style="font-size: 18.57px;">工程实践</a> <a href="/tags/%E6%80%9D%E8%80%83/" style="font-size: 14.29px;">思考</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 15.71px;">生活</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 11.43px;">算法</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">经验</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 11.43px;">网络</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 12.86px;">翻译</a> <a href="/tags/%E8%A7%82%E5%AF%9F/" style="font-size: 10px;">观察</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 17.14px;">读书笔记</a> <a href="/tags/%E8%B5%84%E6%BA%90/" style="font-size: 14.29px;">资源</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/07/21/monaco-editor-practice/">Monaco Editor</a>
          </li>
        
          <li>
            <a href="/2023/06/21/travel-in-sanya/">2023年6月三亚之旅</a>
          </li>
        
          <li>
            <a href="/2023/05/17/chrome-extensions-best-practice/">Chrome Extensions 开发最佳实践</a>
          </li>
        
          <li>
            <a href="/2023/02/16/understanding-react/">React 实现原理之异步渲染</a>
          </li>
        
          <li>
            <a href="/2023/02/09/understanding-jsx/">理解 JSX</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 陈军<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <!-- 小屏设备的导航菜单 -->
<nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
