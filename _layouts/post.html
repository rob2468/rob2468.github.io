<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" type="text/css" href="/css/default.css" />
        <link rel="stylesheet" type="text/css" href="/css/post.css" />
        <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
        <script type="text/javascript" src="https://rawgit.com/rob2468/commentme/master/dist/commentme.js"></script>
        <script type="text/javascript" src="/js/post.js"></script>
        <script type="text/javascript">$(document).ready(generateContentsTable);</script>
        <title>{{ page.title }}</title>
    </head>
    <body>
        <div class="header"></div>

        <div class="main">
        {{ content }}

        <div class="comment_area">
        <!-- comment form -->
        <div class="comment_form">
          <form>
            <input type="text" name="display_name" placeholder="姓名"></input>
            <input type="text" name="email" placeholder="电子邮箱"></input>
            <textarea name="content" placeholder="请输入您的评论"></textarea>
            <button type="button" class="submit submit_normal" onclick=submitForm()><img src="/resources/loading-bubbles.svg"/><span>提交评论</span></button>
            <div class="prompt"></div>
          </form>
        </div>
        <!-- comments -->
        {% assign pageid = page.id %}
        {%if site.data.comments[pageid] %}
            {% assign sorted_comments = (site.data.comments[pageid] | sort: 'date') %}
        {% endif %}
        {% for c in sorted_comments %}
          <div>
              <p>{{ c.author.display_name }} on {{ c.date | date_to_string }}</p>
              <p>{{ c.content | newline_to_br }}</p>
          </div>
        {% else %}
            这篇文章暂没有评论。
        {% endfor %}
        </div>

        <script>
        var timeoutID;
        function submitForm() {
          if ($(".comment_area .submit_normal").length > 0) {
            var TOKEN = "token f3257ed1efef5c1ad10d7337636c3b375735270a";
            var BRANCH_NAME = "comments";
            var OWNER_NAME = "rob2468";
            var REPO_NAME = "rob2468.github.io";
            var pageID = "{{ pageid }}";
            var email = $("input[name='email']").val().trim();
            var dateObj = new Date();
            var date = dateObj.toDateString();
            var display_name = $("input[name='display_name']").val().trim();
            var content = $("textarea[name='content']").val().trim();

            // 字段有效性检查
            function validateDisplayName() {
              var res;
              if (display_name.length === 0) {
                res = "姓名没有可见字符";
              }
              return res;
            }
            function validateEmail() {
              var res;
              if (email.length === 0) {
                res = "电子邮箱没有可见字符";
              }
              return res;
            }
            function validateContent() {
              var res;
              if (content.length === 0) {
                res = "评论内容没有可见字符";
              }
              return res;
            }
            var displayNameValidation = validateDisplayName();
            var emailValidation = validateEmail();
            var contentValidation = validateContent();
            if (!displayNameValidation && !emailValidation && !contentValidation) {
              $(".comment_area .submit").removeClass("submit_normal");
              $(".comment_area .submit").addClass("submit_loading");
              function finnalyCompleteLoading() {
                $(".comment_area .submit").addClass("submit_normal");
                $(".comment_area .submit").removeClass("submit_loading");
              }
              commentme_submitComment(TOKEN, BRANCH_NAME, OWNER_NAME, REPO_NAME, pageID, email, date, display_name, content, function() {
                // completionHandler
                finnalyCompleteLoading();
              }, function() {
                // errorHandler
                finnalyCompleteLoading();
              });
              // test(function() {
              //   // completionHandler
              //   $(".comment_area .submit").addClass("submit_normal");
              //   $(".comment_area .submit").removeClass("submit_loading");
              // }, function() {
              //   // errorHandler
              // });
              // function test(func1, func2) {
              //   setTimeout(func1, 1000);
              // }
            } else {
              var prompt;
              // 存在字段无效情况
              prompt = displayNameValidation? displayNameValidation + "；": "";
              prompt += emailValidation? emailValidation + "；": "";
              prompt += contentValidation? contentValidation + "；": "";
              $(".comment_area .prompt").text(prompt);

              clearTimeout(timeoutID);
              timeoutID = setTimeout(function() {
                $(".comment_area .prompt").text("");
              }, 3000);
            }
          } else {
            // loading
            console.log("loading");
          }
        }
        </script>
        </div><!-- main -->

        <div class="footer">
            <p>powered by github</p>
        </div>
    </body>
</html>
